'use strict';

const { send, handleRateLimit } = require('../../helpers');
const Handler = require('../../structures/pieces/Handler');

const caption = nick =>
  `<b>üëã –ü—Ä–∏–≤—ñ—Ç${nick ? `, ${nick}` : ''}! üòâ</b>

–î—è–∫—É—î–º–æ –∑–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–æ–º ‚ò∫Ô∏è
üìÖ –î–æ –ó–ù–û-2021 –∑ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ –∑–∞–ª–∏—à–∏–ª–æ—Å—å: <b>77 –¥–Ω—ñ–≤</b>

üí¨ –í–∂–µ —á–µ—Ä–µ–∑ –¥–µ–∫—ñ–ª—å–∫–∞ —Ç–∏–∂–Ω—ñ–≤ –≤—ñ–¥–±—É–¥–µ—Ç—å—Å—è –ø—Ä–æ–±–Ω–µ –ó–ù–û
üí¨ –ù–µ—Ä–≤—É—î—à, —â–æ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –º–µ–Ω—à–µ —á–∞—Å—É, –∞ —â–µ –±–∞–≥–∞—Ç–æ —Ç–µ–º —Ç—Ä–µ–±–∞ –≤–∏–≤—á–∏—Ç–∏ —Ç–∞ –∑–∞–∫—Ä—ñ–ø–∏—Ç–∏? 

- –ù–µ —Ö–≤–∏–ª—é–π—Å—è üòâ

‚úÖ –ú–∏ —Ä–æ–∑–ø–æ—á–∏–Ω–∞—î–º–æ —Å–µ—Ä—ñ—é –û–Ω–ª–∞–π–Ω-–Ü–Ω—Ç–µ–Ω—Å–∏–≤—ñ–≤, —â–æ–± –ø—ñ–¥—Å–∏–ª–∏—Ç–∏ —Ç–µ–±–µ üìöüìà
–ü–µ—Ä—à–∏–π –û–Ω–ª–∞–π–Ω-–Ü–Ω—Ç–µ–Ω—Å–∏–≤ –≤—ñ–¥–±—É–¥–µ—Ç—å—Å—è –≤–∂–µ 20-–≥–æ –±–µ—Ä–µ–∑–Ω—è 2021 —Ä–æ–∫—É:

üìï –¢–µ–º–∞: <b>¬´–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä—ñ—è¬ª</b>

<b>–ù–∞ —è–∫—ñ–π —Ç–∏ –¥—ñ–∑–Ω–∞—î—à—Å—è:</b>
üß© –ø—Ä–æ –ø–æ–Ω—è—Ç—Ç—è —Ä–∞–¥—ñ–∞–Ω–Ω–æ–≥–æ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –∫—É—Ç—ñ–≤, —Ç–∞ –æ–¥–∏–Ω–∏—á–Ω–µ –∫–æ–ª–æ
üß© –ø—Ä–æ —á–∏—Å–ª–æ œÄ, –ø–æ–Ω—è—Ç—Ç—è sin, cos, tg —Ç–∞ ctg
üß© —â–æ —Ç–∞–∫–µ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ —è–∫ –ø–æ–±—É–¥—É–≤–∞—Ç–∏ —ó—Ö –≥—Ä–∞—Ñ—ñ–∫–∏?
üß© —è–∫ —Ä–æ–∑–≤‚Äô—è–∑—É–≤–∞—Ç–∏ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–Ω—ñ –≤–∏—Ä–∞–∑–∏  —Ç–∞ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —ó—Ö–Ω—ñ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è?
üß© —è–∫ —Ä–æ–∑–≤‚Äô—è–∑—É–≤–∞—Ç–∏ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–Ω—ñ —Ä—ñ–≤–Ω—è–Ω–Ω—è?
 
‚è≥ –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–µ—Å—ñ—ó: <b>3 –≥–æ–¥. 45 —Ö–≤.</b>
 
–°–∞–º–µ –∑–∞—Ä–∞–∑ —á–∞—Å –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–∏:
üìö –¢–µ–æ—Ä—ñ—é —ñ üìê –ü—Ä–∞–∫—Ç–∏–∫—É`;

const sendMessage = (ctx, id, nick = '') =>
  ctx.telegram
    .sendPhoto(id, 'https://i.imgur.com/wtmswBc.jpg', {
      caption: caption(nick),
      parse_mode: 'HTML',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üì±–†–µ—î—Å—Ç—Ä—É–π—Å—è –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º ‚Ü©Ô∏è', url: 'https://secure.wayforpay.com/payment/ZnoMathematicsUA' }],
        ],
      },
    })
    // eslint-disable-next-line no-empty-function
    .catch(err => {
      if (err.code === 429) handleRateLimit(ctx, err);
      console.error('–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
    });

module.exports = class extends Handler {
  constructor(...args) {
    super(...args, {
      name: 'test',
      types: ['command', 'action'],
    });
  }

  async run(ctx, userID) {
    if (!userID || ![546886852, 409482221].includes(ctx.from.id)) return;

    let success = 0;
    for await (const user of ctx.users) {
      // eslint-disable-next-line no-empty-function
      const data = (await ctx.telegram.getChat(user.id).catch(() => {})) || {};
      await sendMessage(ctx, user.id, data.first_name);
      console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ', user.id);
      success += 1;
    }
    send(ctx, `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ ${success} —Å–æ–æ–±—â–µ–Ω–∏–π`);
  }
};
